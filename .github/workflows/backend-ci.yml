# Proxima Backend CI/CD Pipeline
# Runs tests for all quantum backends on multiple platforms

name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/proxima/backends/**'
      - 'tests/backends/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/proxima/backends/**'
      - 'tests/backends/**'
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # Code Quality Checks
  # ============================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black mypy
          
      - name: Check formatting with Black
        run: black --check src/proxima/backends tests/backends || echo "Black formatting warnings (non-blocking)"
        
      - name: Lint with Ruff
        run: ruff check src/proxima/backends tests/backends || echo "Ruff warnings (non-blocking)"
        
      - name: Type check with MyPy
        run: mypy src/proxima/backends --ignore-missing-imports || echo "Type check warnings (non-blocking)"

  # ============================================
  # Unit Tests - Core Backend Framework
  # ============================================
  test-core:
    name: Core Backend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          
      - name: Run core unit tests
        run: |
          pytest tests/unit -v --tb=short -m "not backend" \
            --junitxml=junit/test-results-core.xml
            
      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-core-${{ matrix.python-version }}
          path: junit/

  # ============================================
  # Backend Tests - QuEST
  # ============================================
  test-quest:
    name: QuEST Backend
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libeigen3-dev
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyquest-cffi || echo "QuEST installation failed, using mocks"
          
      - name: Run QuEST backend tests
        run: |
          pytest tests/backends/test_quest*.py -v --tb=short \
            --junitxml=junit/test-quest.xml
            
      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-quest
          path: junit/

  # ============================================
  # Backend Tests - cuQuantum (Mocked - No GPU in CI)
  # ============================================
  test-cuquantum:
    name: cuQuantum Backend (Mocked)
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install qiskit qiskit-aer
          
      - name: Run cuQuantum tests (mocked)
        run: |
          pytest tests/backends/test_cuquantum*.py -v --tb=short \
            -m "not requires_gpu" \
            --junitxml=junit/test-cuquantum-mocked.xml
        env:
          PROXIMA_MOCK_GPU: "true"
            
      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-cuquantum
          path: junit/

  # ============================================
  # Backend Tests - qsim
  # ============================================
  test-qsim:
    name: qsim Backend
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install qsimcirq cirq || echo "qsim installation failed, using mocks"
          
      - name: Run qsim backend tests
        run: |
          pytest tests/backends/test_qsim*.py -v --tb=short \
            --junitxml=junit/test-qsim.xml
            
      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-qsim
          path: junit/

  # ============================================
  # Backend Selection Tests
  # ============================================
  test-backend-selection:
    name: Backend Selection Logic
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install cirq qiskit qiskit-aer
          
      - name: Run backend selection tests
        run: |
          pytest tests/backends/test_backend_selection.py -v --tb=short \
            --junitxml=junit/test-backend-selection.xml
            
      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-backend-selection
          path: junit/

  # ============================================
  # Integration Tests
  # ============================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-quest, test-cuquantum, test-qsim]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install cirq qiskit qiskit-aer qsimcirq || true
          pip install pyquest-cffi || true
          
      - name: Run integration tests
        run: |
          pytest tests/backends/test_integration.py -v --tb=short \
            --junitxml=junit/test-integration.xml
            
      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-integration
          path: junit/

  # ============================================
  # Performance Benchmarks
  # ============================================
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [test-integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest-benchmark
          pip install cirq qiskit qiskit-aer qsimcirq || true
          pip install pyquest-cffi || true
          
      - name: Run benchmarks
        run: |
          pytest tests/backends/test_benchmark.py -v \
            --benchmark-json=benchmark-results.json \
            -m "not slow" \
            || true
            
      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: benchmark-results.json

  # ============================================
  # Validation Tests
  # ============================================
  test-validation:
    name: Result Validation
    runs-on: ubuntu-latest
    needs: [test-integration]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install cirq qiskit qiskit-aer qsimcirq || true
          pip install pyquest-cffi || true
          
      - name: Run validation tests
        run: |
          pytest tests/backends/test_validation.py -v --tb=short \
            --junitxml=junit/test-validation.xml
            
      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-validation
          path: junit/

  # ============================================
  # Windows Compatibility
  # ============================================
  test-windows:
    name: Windows Compatibility
    runs-on: windows-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install cirq qiskit qiskit-aer
          
      - name: Run backend tests on Windows
        run: |
          pytest tests/backends/test_backend_selection.py -v --tb=short

  # ============================================
  # macOS Compatibility
  # ============================================
  test-macos:
    name: macOS Compatibility
    runs-on: macos-latest
    needs: [lint]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install cirq qiskit qiskit-aer
          
      - name: Run backend tests on macOS
        run: |
          pytest tests/backends/test_backend_selection.py -v --tb=short

  # ============================================
  # Final Status Check
  # ============================================
  backend-ci-success:
    name: Backend CI Success
    runs-on: ubuntu-latest
    needs: [lint, test-core, test-quest, test-cuquantum, test-qsim, 
            test-backend-selection, test-integration, test-validation]
    if: always()
    
    steps:
      - name: Check all jobs passed
        run: |
          echo "Checking job statuses..."
          echo "lint: ${{ needs.lint.result }}"
          echo "test-core: ${{ needs.test-core.result }}"
          echo "test-quest: ${{ needs.test-quest.result }}"
          echo "test-cuquantum: ${{ needs.test-cuquantum.result }}"
          echo "test-qsim: ${{ needs.test-qsim.result }}"
          echo "test-backend-selection: ${{ needs.test-backend-selection.result }}"
          echo "test-integration: ${{ needs.test-integration.result }}"
          echo "test-validation: ${{ needs.test-validation.result }}"
          
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint failed"
            exit 1
          fi
          echo "All Backend CI jobs passed!"
