# Migration Guide: v0.2.x to v0.3.x

This guide covers migrating your Proxima installation and code from version 0.2.x to 0.3.x.

## Overview

Version 0.3 introduces:

- Additional backend support (QuEST, cuQuantum, qsim)
- Enhanced Web API with session management
- Improved plugin architecture with hooks
- Performance optimizations
- Better GPU support

## Breaking Changes

### 1. Backend Registry Changes

**Before (v0.2):**
```python
from proxima.backends import get_backend

backend = get_backend("cirq")
```

**After (v0.3):**
```python
from proxima.backends import BackendRegistry

registry = BackendRegistry()
backend = registry.get("cirq")

# Or use the convenience function
from proxima.backends import get_backend
backend = get_backend("cirq")  # Still works
```

### 2. Plugin Initialization Changes

**Before (v0.2):**
```python
def initialize(self, context: PluginContext) -> None:
    self._context = context
```

**After (v0.3):**
```python
def initialize(
    self, 
    context: PluginContext,
    hook_manager: Optional[HookManager] = None
) -> None:
    self._context = context
    if hook_manager:
        hook_manager.register(HookType.BEFORE_EXECUTION, self._on_start)
```

### 3. Session API Changes

**Before (v0.2):**
```python
# Sessions were implicit
result = backend.run(circuit, shots=1000)
```

**After (v0.3):**
```python
# Explicit session management
from proxima.api.services import SessionService

service = SessionService()
session = service.create_session(name="My Session", backend="cirq")
job = service.submit_job(session["session_id"], circuit=circuit, shots=1000)
```

### 4. Configuration Schema Changes

**Before (v0.2):**
```toml
[simulation]
backend = "cirq"
shots = 1000
```

**After (v0.3):**
```toml
[simulation]
default_backend = "cirq"
default_shots = 1000

[simulation.execution]
async_enabled = true
max_concurrent_jobs = 4
```

### 5. Result Metadata Changes

**Before (v0.2):**
```python
result.metadata  # Dict[str, Any]
```

**After (v0.3):**
```python
result.metadata          # Dict[str, Any]
result.circuit_info      # CircuitInfo dataclass
result.backend_info      # BackendInfo dataclass
result.timing            # TimingInfo dataclass
```

## New Features

### Additional Backends

v0.3 adds support for:

- **QuEST**: High-performance quantum simulator
- **cuQuantum**: NVIDIA GPU-accelerated simulation
- **qsim**: Google's quantum circuit simulator

```python
# QuEST
backend = get_backend("quest", num_threads=8)

# cuQuantum (requires NVIDIA GPU)
backend = get_backend("cuquantum", device="cuda:0")

# qsim
backend = get_backend("qsim", use_gpu=True)
```

### Hook System

Register callbacks for execution events:

```python
from proxima.plugins.hooks import HookManager, HookType, HookContext

hook_manager = HookManager()

@hook_manager.on(HookType.BEFORE_EXECUTION)
def log_start(context: HookContext):
    print(f"Starting execution on {context.data['backend']}")

@hook_manager.on(HookType.AFTER_EXECUTION)
def log_end(context: HookContext):
    print(f"Completed in {context.data['execution_time']:.2f}s")
```

### Web API Session Management

```python
import httpx

# Create session
response = httpx.post("http://localhost:8000/api/v1/sessions", json={
    "name": "My Session",
    "backend": "cirq",
    "ttl_minutes": 60
})
session = response.json()

# Submit job to session
response = httpx.post(f"http://localhost:8000/api/v1/sessions/{session['session_id']}/jobs", json={
    "circuit": circuit_qasm,
    "shots": 1000
})
```

## Migration Steps

### Step 1: Update Dependencies

```bash
pip install --upgrade proxima-agent>=0.3.0
```

For GPU support:
```bash
pip install proxima-agent[gpu]>=0.3.0
```

### Step 2: Update Configuration

```toml
# proxima.toml - v0.3 format
[simulation]
default_backend = "cirq"
default_shots = 1000

[simulation.execution]
async_enabled = true
max_concurrent_jobs = 4
timeout_seconds = 300

[backends.cirq]
precision = "double"

[backends.quest]
num_threads = 4

[backends.cuquantum]
device = "cuda:0"
precision = "single"

[api]
host = "0.0.0.0"
port = 8000
cors_origins = ["*"]
```

### Step 3: Update Plugin Initialization

If you have custom plugins, update their initialization:

```python
from proxima.plugins.base import Plugin, PluginContext
from proxima.plugins.hooks import HookManager, HookType
from typing import Optional

class MyPlugin(Plugin):
    name = "my-plugin"
    version = "1.0.0"
    description = "My custom plugin"
    
    def initialize(
        self, 
        context: PluginContext,
        hook_manager: Optional[HookManager] = None
    ) -> None:
        self._context = context
        self._hook_manager = hook_manager
        
        # Register hooks if manager provided
        if hook_manager:
            hook_manager.register(
                HookType.AFTER_EXECUTION,
                self._on_execution_complete
            )
    
    def _on_execution_complete(self, ctx):
        # Handle completion
        pass
```

### Step 4: Update Session Usage

If using the API:

```python
# Old: Direct backend usage
from proxima.backends import get_backend

backend = get_backend("cirq")
result = backend.run(circuit, shots=1000)

# New: Session-based usage for long-running work
from proxima.api.services import SessionService

service = SessionService()
session = service.create_session(name="Analysis", backend="cirq")

try:
    job = service.submit_job(
        session["session_id"],
        circuit=circuit,
        shots=1000
    )
    # Job tracking, pause/resume, etc.
finally:
    service.delete_session(session["session_id"])
```

### Step 5: Adopt New Backends (Optional)

```python
# Check backend availability
from proxima.backends import BackendRegistry

registry = BackendRegistry()
print(f"Available backends: {registry.list_available()}")

# Use new backends
if "cuquantum" in registry.list_available():
    backend = registry.get("cuquantum")
    result = backend.run(circuit, shots=1000)
```

## Deprecated Features

| Feature | Replacement | Removal |
|---------|-------------|---------|
| `Backend.execute()` | `Backend.run()` | v0.4 |
| Implicit sessions | `SessionService` | v0.4 |
| `[simulation].backend` | `[simulation].default_backend` | v0.4 |

## Backwards Compatibility

v0.3 maintains backwards compatibility with v0.2 code for most use cases:

```python
# Still works
from proxima.backends import get_backend
backend = get_backend("cirq")
result = backend.run(circuit, shots=1000)
print(result.counts)
```

New features are additive and don't require immediate migration.

## Troubleshooting

### GPU Backend Not Found

If `cuquantum` is not available:

```bash
# Check CUDA installation
nvidia-smi

# Install cuQuantum
pip install cuquantum-python

# Verify
python -c "from proxima.backends import get_backend; print(get_backend('cuquantum').is_available())"
```

### Session Timeouts

If sessions expire unexpectedly:

```toml
# Increase TTL in config
[api.sessions]
default_ttl_minutes = 120
max_ttl_minutes = 480
```

### Hook Registration Errors

If hooks aren't firing:

```python
# Ensure hook manager is passed to plugins
from proxima.plugins.hooks import HookManager

hook_manager = HookManager()
plugin.initialize(context, hook_manager=hook_manager)
```

## Performance Improvements

v0.3 includes significant performance improvements:

| Scenario | v0.2 | v0.3 | Improvement |
|----------|------|------|-------------|
| 20-qubit simulation | 45s | 32s | 29% faster |
| Circuit compilation | 1.2s | 0.8s | 33% faster |
| Batch execution | 120s | 75s | 38% faster |

Enable optimizations:

```toml
[performance]
enable_caching = true
parallel_compilation = true
optimize_circuits = true
```

## Getting Help

- Documentation: https://proxima.readthedocs.io/migration/
- GitHub Issues: https://github.com/yourusername/proxima/issues
- Discord: https://discord.gg/proxima
